---
title: "Meeting view"
author: "Dr Greig Russell"
date: "20 July 2017"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = "png", fig.path = "/home/greig/R-projects/Clinical_audits/Theatre/images")
```

```{r load_the_libraries, echo=FALSE, message=FALSE, warning=FALSE}
#load the libraries
library(flexdashboard)
library(rmarkdown)
library(knitr)
library(ggthemes)
library(tidyverse)
library(lubridate)
library(forcats)
library(qcc)
library(tidyr)
```

```{r declare_the_functions, echo=FALSE, message=FALSE, warning=FALSE}
#Declare functions

convertTime <- function(x){
  time <- hour(x)*60 + minute(x)
  }
```

```{r declare_the_variables, echo=FALSE, message=FALSE, warning=FALSE}
Column_names <- c(
  "Counter",
  "NHI",
  "Theatre",
  "Type",
  "Original_Ward",
  "Surgeon",
  "Surgeon_Teach",
  "Anaesthetist",
  "Anaesthetist_Teach", 
  "Anaesthetic",
  "Anaesthetist_Risk",
  "Operation_Code",
  "Operation_Code_Extention",
  "PurchaserNumber",
  "Patient_Side",
  "Specialty_OverRide",
  "Booking_In_Date",
  "Booking_In_Time",
  "Event_Date",
  "Arrival_In_Anaesthetic_Room",
  "Anaesthesia_Start",
  "Patient_Ready_for_Operation",
  "Operation_Start",
  "Operation_End",
  "Recovery_Takeover",
  "Patient_Open _Eyes_On_Command,Recovery_Complete",
  "Left_Recovery",
  "Anaesthetic_Time",
  "Operation_Time",
  "Scrub_Nurse",
  "Charge_Nurse",
  "Anaesthetic_Assist",
  "AnaestheticAssistTeach",
  "Problem_Code",
  "DirectMaterialCost",
  "Planned_Return",
  "SessionCode",
  "Verified",
  "Episode",
  "AdmissionType",
  "Modified",
  "ModifiedBy",
  "Processed",
  "Created",
  "EventComments",
  "TheatreOther",
  "PlannedOperation",
  "GRN",
  "Admission_Date",
  "AdmissionWard",
  "EpisodeNumber",
  "TimeOut",
  "UnplannedReturn",
  "Problem_Description",
  "Group_Description",
  "Specialty_Description",
  "SpecialtyCode",
  "Operation_Description"
)
```

```{r read_the_data, echo=FALSE, message=FALSE, warning=FALSE}
Raw_data <- read_csv("/home/greig/R-projects/Clinical_audits/Theatre/OTIS_rawData.csv", col_names = Column_names, skip = 1)
```

```{r tidy_the_data, echo=FALSE, message=FALSE, warning=FALSE}
Raw_data$NHI <- as.factor(Raw_data$NHI)
Raw_data$Theatre <- as.factor(Raw_data$Theatre)
Raw_data$Type <- as.factor(Raw_data$Type)
Raw_data$Original_Ward <- as.factor(Raw_data$Original_Ward)
Raw_data$Surgeon <- as.factor(Raw_data$Surgeon)
Raw_data$Surgeon_Teach <- as.factor(Raw_data$Surgeon_Teach)
Raw_data$Anaesthetist <- as.factor(Raw_data$Anaesthetist)
Raw_data$Anaesthetist_Teach <- as.factor(Raw_data$Anaesthetist_Teach)
Raw_data$Anaesthetic <- as.factor(Raw_data$Anaesthetic)
Raw_data$Operation_Code <-  as.factor(Raw_data$Operation_Code)
Raw_data$Operation_Code_Extention <- as.factor(Raw_data$Operation_Code_Extention)
Raw_data$PurchaserNumber <- as.factor(Raw_data$PurchaserNumber)
Raw_data$Patient_Side <- as.factor(Raw_data$Patient_Side)
Raw_data$Specialty_OverRide <- as.factor(Raw_data$Specialty_OverRide)
Raw_data$Anaesthesia_Start <- as.character(Raw_data$Anaesthesia_Start)
Raw_data$Operation_Start <- as.character(Raw_data$Operation_Start)
Raw_data$Operation_End <- as.character(Raw_data$Operation_End)
Raw_data$Recovery_Takeover <- as.character(Raw_data$Recovery_Takeover)
Raw_data$Scrub_Nurse <-  as.factor(Raw_data$Scrub_Nurse)
Raw_data$Charge_Nurse <- as.factor(Raw_data$Charge_Nurse)
Raw_data$Anaesthetic_Assist <- as.factor(Raw_data$Anaesthetic_Assist)
Raw_data$AnaestheticAssistTeach <- as.factor(Raw_data$AnaestheticAssistTeach)
Raw_data$Problem_Code <-  as.factor(Raw_data$Problem_Code)
Raw_data$Planned_Return <- as.factor(Raw_data$Planned_Return)
Raw_data$SessionCode <- as.factor(Raw_data$SessionCode)
Raw_data$AdmissionType <- as.factor(Raw_data$AdmissionType)
Raw_data$EventComments <- as.factor(Raw_data$EventComments)
Raw_data$TheatreOther <-  as.factor(Raw_data$TheatreOther)
Raw_data$PlannedOperation <-  as.factor(Raw_data$PlannedOperation)
Raw_data$AdmissionWard <- as.factor(Raw_data$AdmissionWard)
Raw_data$EpisodeNumber <- as.factor(Raw_data$EpisodeNumber)
Raw_data$TimeOut <- as.factor(Raw_data$TimeOut)
Raw_data$UnplannedReturn <-  as.factor(Raw_data$UnplannedReturn)
Raw_data$Problem_Description <- as.factor(Raw_data$Problem_Description)
Raw_data$Group_Description <- as.factor(Raw_data$Group_Description)
Raw_data$Specialty_Description <- as.factor(Raw_data$Specialty_Description)
Raw_data$Operation_Description <- as.factor(Raw_data$Operation_Description)
```

```{r tansform_the_data, echo=FALSE, warning=FALSE, message=FALSE}
Raw_data$Op_start <- ifelse(nchar(Raw_data$Anaesthesia_Start) == 4, Raw_data$Operation_Start, Raw_data$Anaesthesia_Start)
Raw_data$Op_start <- paste(Raw_data$Event_Date, Raw_data$Op_start, sep = " ")
Raw_data$Op_start <- dmy_hms(Raw_data$Op_start)
Raw_data$Op_start_min <- convertTime(Raw_data$Op_start)

Raw_data$Op_end <- ifelse(nchar(Raw_data$Recovery_Takeover) == 4, Raw_data$Operation_End, Raw_data$Recovery_Takeover)
Raw_data$Op_end <- paste(Raw_data$Event_Date, Raw_data$Op_end, sep = " ")
Raw_data$Op_end <- dmy_hms(Raw_data$Op_end)
Raw_data$Op_end_min <- convertTime(Raw_data$Op_end)

Raw_data$Op_duration <-  Raw_data$Op_end_min - Raw_data$Op_start_min

Raw_data$Event_Date <- dmy(Raw_data$Event_Date)

Raw_data <- Raw_data %>% 
  mutate(Month = month(Event_Date), 
         DOW = wday(Event_Date), 
         Week = week(Event_Date), 
         Day_date = yday(Event_Date))

```

```{r otis_data_set, echo=FALSE, message=FALSE, warning=FALSE}
#select the FY2016

Otis <- Raw_data %>% 
  filter(Event_Date >= "2016-07-01" & Event_Date < "2017-07-01")

#Transform Otis data set

Otis$Adjusted_week <- ifelse(Otis$Week > 26, Otis$Week - 26, Otis$Week + 26)

#Declare session times as per 11.July.2017 meeting slide 11
#Stored as minutes after midnight
Morning_start <- 495 #8:15
Morning_end <- 735 #12:15
Afternoon_start <- 795 #13:15
Afternoon_end <- 1035 #17:15
```

#Introduction {.sidebar}
Data dashboard for the MDHB theatre optimization project.

#Waterfall

##Layout {.tabset .tabset-fade}

###Assumptions

1. This is an analysis of the OTIS data set, as collected by the theatre team and supplied by DQHI.
2. The data set was distributed to all parties, so all have the same data set.
3. The study period was the last financal year.
4. The beginning and end times for theatre sessions were as agreed.
5. Audit afternoons were Friday afternoons with more than 3 three theatres having missing data.

###Limitations

1. Data collection issues within theatre.
2. Data entry issues.
3. The underlying data set is therefore technically a chaotic and messy data set.
4. The model parameters have been vigerously debated;
+ parameters are unique to the waterfall chart
+ but they are arbitary.
+ have been decided on a causing the least distortion basis.
+ so there are positive & negative distortions for individual sessions.

###Chart

![alt text](Waterfall.png)

#Theatre

##layout{.tabset .tabset-fade}

###Suite
```{r whole_theatre, echo=FALSE, message=FALSE, warning=FALSE}
ot_count <- array(1:366, dim = c(366,1440))
  for (i in 1:366) {
    for (j in 1:1440) {
      ot_count[[i,j]] <- 0
    }
  }

for  (k in 1:7) {
 graphTheatre <- filter(Otis, Theatre == k)
 graphTheatre <- graphTheatre %>% 
   filter(!is.na(Op_start_min) & !is.na(Op_end_min))
 x <- graphTheatre$Op_start_min
 y <- graphTheatre$Op_end_min
 z <- graphTheatre$Day_date
 loop <- nrow(graphTheatre)
 x <- as.list(x)
 y <- as.list(y)
 z <- as.list(z)

 for (i in 1:loop) {
   day <- z[[i]]
   start <- x[[i]]
   if (start == 0) start = 1
   end <- y[[i]]
   if (end == 0) end = 1
   for (j in start:end) {
     ot_count[[day,j]] <- ot_count[[day,j]] + 1
   }
 }
}


time_stamp <- array(1:2, dim = c(1440,2))

for (j in 1:1440) {
  time_stamp[[j,1]] <- j
  time_stamp[[j,2]] <- 0
}

for (j in 495:735) {
  time_stamp[[j,2]] <- 7
}

for (j in 810:1050) {
  time_stamp[[j,2]] <-  7
}

time_stamp <- as.tibble(time_stamp)

time_stamp <- time_stamp %>% 
  select(V2) %>% 
  rename(time_stamp = V2)

mean_pat <-  apply(ot_count,2, mean)
mean_pat <-  as.tibble(mean_pat)
mean_pat <- rename(mean_pat, Average = value)
quantile_pat <- apply(ot_count,2, quantile, 0.85)
quantile_pat <- as.tibble(quantile_pat)
quantile_pat <- rename(quantile_pat, percentile_85 = value)

graph_data <- as.tibble(1:1440)
graph_data <- rename(graph_data, Time = value)

graph_data <- bind_cols(graph_data, mean_pat)
graph_data <- bind_cols(graph_data, quantile_pat)

graph_data <- graph_data %>% 
  mutate(Time = Time / 60, Average = Average, percentile_85 = percentile_85)

graph_data <- bind_cols(graph_data, time_stamp)

ggplot(data = graph_data) +
  geom_col(aes(x = Time, y = Average, colour = "red")) +
  geom_line(aes(x= Time, y = percentile_85, colour = "blue")) +
  geom_line(aes(x= Time, y = time_stamp, colour = "green")) +
  scale_y_continuous(breaks = seq(0,8,1)) +
  scale_x_continuous(breaks = seq(0,24,2)) +
  ggtitle("               Theatre usage 2016 / min (including Theatre 4)") +
  labs(x = "Time (hrs)", y = "Average number of patients / min of theatre") +
  scale_color_manual(name = "Legend", guide = guide_legend(override.aes=aes(fill = "white")), values = c("green" = "green", "blue" = "blue", "red" = "red"), labels = c("Top 15% lists", "Max # pats/min", "Avg # pats/min")) +
  theme(legend.text = element_text(size = 7)) +
  theme_economist()
```

